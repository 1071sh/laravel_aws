name: Laravel CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
    types: [closed]

  workflow_dispatch:

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"
      - name: Install Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
      - name: Generate key
        run: php artisan key:generate
      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache
      - name: Install Node Dependencies
        run: npm install
      - name: Build Frontend Assets
        run: npm run build
      - name: Create Database
        run: |
          mkdir -p database
          touch database/database.sqlite
      - name: Execute tests (Unit and Feature tests) via PHPUnit/Pest
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
        run: php artisan test

  deploy:
    needs: laravel-tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      # IP取得ライブラリをインストール
      - name: Public IP Install
        id: ip
        uses: haythem/public-ip@v1.3

      # BranchをCheckout
      - name: Checkout
        uses: actions/checkout@v4

      # AWS CLIをインストールする
      - name: AWS CLI install
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          aws --version

      # AWS CLIにキーを設定をする
      - name: AWS set Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-3

      # デプロイする
      - name: Deploy to EC2
        run: |
          # SSHのセキュリティグループを開放する
          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32 || echo "既に開放されている可能性があります"

          # SSH接続して、Laravelデプロイを実行
          echo "${{ secrets.PRIVATE_KEY }}" > private_key
          chmod 600 private_key
          ssh -oStrictHostKeyChecking=no ${{ secrets.USER_NAME }}@${{ secrets.HOST_NAME }} -i private_key << 'EOF'
            set -e
            cd /var/www/laravel_aws

            # Gitから最新を取得
            git fetch --prune
            git checkout main

            # ローカル変更をstashしてからpull
            git stash
            git pull origin main
            git stash drop 2>/dev/null || true

            # Composerの依存関係を更新（本番環境用）
            composer install --no-dev --optimize-autoloader --no-interaction

            # Node.jsがインストールされているか確認、なければインストール
            if ! command -v npm &> /dev/null; then
              echo "Node.js is not installed. Installing..."
              curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
              sudo yum install -y nodejs
            fi

            # Node.jsの依存関係をインストールしてビルド
            npm install
            npm run build

            # Laravelのキャッシュをクリア
            php artisan config:clear
            php artisan cache:clear
            php artisan view:clear
            php artisan route:clear

            # マイグレーション実行（必要に応じてコメント解除）
            # php artisan migrate --force

            # 本番環境用のキャッシュを生成
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # ストレージリンク（初回のみ必要、エラーは無視）
            php artisan storage:link 2>/dev/null || true

            # 権限設定（Nginx + PHP-FPM環境）
            chmod -R 775 storage bootstrap/cache
            chown -R ec2-user:nginx storage bootstrap/cache

            # デプロイ後のログチェック（最新のエラーを確認）
            echo "=== Checking Laravel logs ==="
            tail -20 storage/logs/laravel.log 2>/dev/null || echo "No Laravel log file found"
          EOF

          # SSHのセキュリティグループを閉じる
          aws ec2 revoke-security-group-ingress --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32 || echo "既に閉じられている可能性があります"
